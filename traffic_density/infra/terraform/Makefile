# Makefile for Terraform Operations
# Simplifies common Terraform commands

.PHONY: help init plan apply destroy output clean fmt validate

# Default target
help:
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "  Traffic Detection System - Terraform Commands"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "Setup:"
	@echo "  make setup      - Configure variables and initialize"
	@echo "  make init       - Initialize Terraform"
	@echo ""
	@echo "Deployment:"
	@echo "  make plan       - Preview infrastructure changes"
	@echo "  make apply      - Deploy infrastructure"
	@echo "  make destroy    - Destroy all infrastructure"
	@echo ""
	@echo "Operations:"
	@echo "  make output     - Show all outputs"
	@echo "  make env        - Generate .env file"
	@echo "  make test       - Test SNS publishing"
	@echo ""
	@echo "Maintenance:"
	@echo "  make fmt        - Format Terraform files"
	@echo "  make validate   - Validate configuration"
	@echo "  make clean      - Clean Terraform cache"
	@echo ""
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Setup configuration
setup:
	@if [ ! -f terraform.tfvars ]; then \
		echo "Creating terraform.tfvars from example..."; \
		cp terraform.tfvars.example terraform.tfvars; \
		echo "âœ… Created terraform.tfvars"; \
		echo "âš ï¸  Please edit terraform.tfvars with your values"; \
	else \
		echo "âœ… terraform.tfvars already exists"; \
	fi
	@$(MAKE) init

# Initialize Terraform
init:
	@echo "ğŸ”§ Initializing Terraform..."
	@terraform init
	@echo "âœ… Terraform initialized"

# Plan changes
plan:
	@echo "ğŸ“‹ Planning infrastructure changes..."
	@terraform plan
	@echo "âœ… Plan complete"

# Apply changes
apply:
	@echo "ğŸš€ Deploying infrastructure..."
	@terraform apply
	@echo "âœ… Infrastructure deployed"
	@echo ""
	@$(MAKE) instructions

# Destroy infrastructure
destroy:
	@echo "âš ï¸  WARNING: This will destroy all infrastructure!"
	@echo "Press Ctrl+C to cancel, or"
	@read -p "Type 'yes' to continue: " confirm && [ "$$confirm" = "yes" ]
	@terraform destroy
	@echo "âœ… Infrastructure destroyed"

# Show outputs
output:
	@terraform output

# Generate .env file
env:
	@echo "ğŸ“ Generating .env file..."
	@terraform output -raw env_file_content > ../../.env
	@echo "âœ… .env file created at ../../.env"
	@echo ""
	@echo "âš ï¸  IMPORTANT: Add .env to .gitignore if not already present"

# Show setup instructions
instructions:
	@terraform output -raw setup_instructions

# Test SNS publishing
test:
	@echo "ğŸ§ª Testing SNS publishing..."
	@TOPIC_ARN=$$(terraform output -raw sns_topic_arn); \
	aws sns publish \
		--topic-arn "$$TOPIC_ARN" \
		--message '{"test":"message","timestamp":"'$$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' \
		--message-group-id "test-group" \
		--message-deduplication-id "test-$$(date +%s)"
	@echo "âœ… Test message sent"

# Format Terraform files
fmt:
	@echo "ğŸ¨ Formatting Terraform files..."
	@terraform fmt -recursive
	@echo "âœ… Files formatted"

# Validate configuration
validate:
	@echo "âœ… Validating Terraform configuration..."
	@terraform validate
	@echo "âœ… Configuration valid"

# Clean Terraform cache
clean:
	@echo "ğŸ§¹ Cleaning Terraform cache..."
	@rm -rf .terraform
	@rm -f .terraform.lock.hcl
	@rm -f terraform.tfstate.backup
	@echo "âœ… Cache cleaned"
	@echo "âš ï¸  Run 'make init' to reinitialize"

# Show current state
state:
	@terraform state list

# Quick deployment (plan + apply)
deploy: plan
	@$(MAKE) apply
